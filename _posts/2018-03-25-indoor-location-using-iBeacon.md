---
title: 使用iBeacon实现室内定位
date: 2016-03-01 10:30:00
categories: algorithm
tags:
  - iBeacon
  - location
---
# 前言
鉴于室内无法使用GPS定位，目前较多利用Wi-Fi、蓝牙、Zigbee、UWB和蜂窝网络等无线通信技术实现室内定位。iBeacon是苹果公司2013年推出的一种基于Bluetooth 4.0 Low Energy(BLE)的通信协议。简单的说，iBeacon的工作方式是广播的方式，配备iBeacon的智能设备能够感知到周围的所有iBeacon发射器的信息，然后通过其他网络与云端进行数据交互。该技术相比其他技术，具有低功耗、低成本、良好兼容性等优势，同时又有苹果公司的支持，前途可期。
<!-- more -->
定位算法是整个定位系统的核心所在，直接决定了定位精度和用户体验。目前有两种定位算法较为常用，一种是三边测量法（三角定位法），另一种是指纹法。两种方法各有各的优缺点。本文采用三边测量法，该方法的优点是原理简单，容易实现，设备扩充便捷，缺点是易受环境干扰。

因此本文的解决方案是采用iBeacon和三边测量法实现室内定位。本文中使用iBeacon基站采用了TI CC2541蓝牙芯片。由于iBeacon是一套开放的协议，因此无论是iOS还是Android手机，只要硬件上支持低功耗蓝牙（BLE），即可适用iBeacon协议与应用。本文使用iPhone进行测试。

# 算法简介
![三边测量法]({{ site.url }}/assets/images/ trilateration.jpg)

上图是三边测量定位法的原理。假设D是移动设备，A、B、C是iBeacon基站。D通过扫描到周围iBeacon信息，得到与A、B、C点的距离，由于A、B、C的位置固定且已知，通过三个圆的交点即确定了D的坐标。当然，这只是理想的状况，实际中情况更复杂，可能会同时收到10多个iBeacon基站的信息，而且无线测距的精度会很不稳定，造成三圆相交没有交点的情况，需要我们自己设计算法来解决这些问题。

![iBeacon定位算法流程]({{ site.url }}/assets/images/ibeacon_flow.jpg)

**预处理**：由于实际环境中手机可以会同时扫描到周边大量的iBeacon广播消息，我们需要过滤掉那些信号较差和距离较远的基站，因为这些基站的数据本身误差非常大，会对定位结果造成不利影响。

**LM算法**：Levenberg-Marquardt莱文贝格－马夸特算法。通过多个iBeacon基站坐标和距离来解算移动目标的坐标，数学上可归结为求解非线性最小二乘法问题。而LM算法是较为常用的一种求解算法，该方法优点是求解成功率高，不易出现无解的状况，缺点是计算量相对较大，鉴于目前智能手机的CPU计算能力非常强大，因此使用LM算法是合适的选择。

**Kalman滤波算法**：卡尔曼滤波算法广泛应用于目标跟踪、机器视觉等工程领域，我们对定位坐标进行kalman滤波算法处理，可以有效地消除较大的误差，使移动定位过程更加平滑。

# 软件实现

目前该定位算法主要应用平台是Android和iOS，考虑到平台移植性，本文使用C实现定位算法，并封装成算法库，iOS平台直接编译成静态库，Android平台添加JNI接口编译成动态库。

```c++
/**
 * name iBeacon location
 * param  transmissions       -I      iBeacon扫描结果指针数组
          transmissionCount   -I      每次扫描到的基站个数数组
          initLocation        -I      初始化手机坐标
          targetLocation      -O      手机定位坐标
 * return BLS_LOCATION_OK， 定位成功；
          BLS_TRANSMISSIONS_FEW， 有效扫描数据太少；
          BLS_LOCATION_FAILED，定位失败；
**/
int triangulation_nls(BLS_TRANSMISSION *transmissions[], int *transmissionCount, BLS_LOCATION *initLocation, BLS_LOCATION *location);
```
该接口返回的是最终的定位坐标结果，可供app调用，比如在地图上显示。卡尔曼滤波算法要保存一些历史数据（上一次运算的结果），由于该接口对于本应用来说是非可重入的，即一个手机同一时刻只会有一个调用，因此可以用静态变量来存储历史数据。LM算法求坐标仅适用于平面坐标系（笛卡尔坐标系），而系统使用的是经纬度坐标系，因此需要进行坐标转换。本例中，由于涉及区域非常小（仅限于一幢建筑内），因此采用经度与x轴、纬度与y轴固定比例尺的方式。

# 系统实现
本文涉及的室内定位系统应用于X公司停车场综合解决方案中。应用场景是提供给大型停车场中的车主反向寻车使用。该系统从网络结构考虑，主要分平台端、设备端和手机端三部分。

平台是指部署在服务器上管理平台，通过平台来记录和管理所有iBeacon基站的设备信息（UUID、MAC、经纬度坐标、坐标转换比例尺等）。

iBeacon设备部署在地下停车场过道上，按照对定位精度需求不同，可以布成两排或者一排。该设备类似火柴盒大小，用钮扣电池供电，可持续工作半年至1年时间。

手机端需要安装专用的app，通过蓝牙接口接收iBeacon的广播消息，该消息含有iBeacon基站的ID、接收信号强度值等信息，通过手机操作系统提供的API可以将接收信号强度转化为距离值。然后手机会通过蜂窝或者WIFI网络与平台通信，获取所有基站对应的坐标值等，将所有这些数据送给算法库，最终得到一个经纬度坐标，即是手机的定位坐标。

![app ui]({{ site.url }}/assets/images/app_screenshot.jpg)

# 总结
本文提及的室内定位系统可以集成到停车场、商超楼宇等综合管控平台中，通过人员定位为基础，实现诸多扩展应用，提升商业中心的用户体验。经实际测试，本方案定位算法的定位精度平均在3米左右，可以满足停车场应用。另一种实现的方法是使用指纹法，实现成本和维护难度更大，但定位效果会更好，本文不再展开。
